<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#484838" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>BOLT</title>
  <style>
    /* CSS Styles */
    :root{ --bg:#484838; --panel:#343427; --panel2:#2c2c21; --text:#f7f1df; --muted:#d2c79c; --line:#5f5a42; --accent:#f4c300; --good:#35d07f; --warn:#ffc857; --bad:#ff5c7a; --shadow: 0 10px 30px rgba(0,0,0,.35); --r: 14px; --mono: ui-monospace, SFMono-Regular, Menlo, monospace; --sans: system-ui, -apple-system, sans-serif; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:var(--sans); background:radial-gradient(1200px 600px at 15% 0%, rgba(244,195,0,.14) 0%, transparent 60%), radial-gradient(900px 500px at 100% 25%, rgba(244,195,0,.10) 0%, transparent 55%), var(--bg); color:var(--text); }
    .app{display:grid; grid-template-columns: 390px 1fr; gap:14px; height:100dvh; min-height:100vh; padding:14px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; min-height:0;}
    header{padding:14px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.01));}
    header .title{font-weight:800; letter-spacing:.2px; font-size:15px;}
    header .subtitle{color:var(--muted); font-size:12px; margin-top:2px;}
    .stack{display:flex; flex-direction:column; gap:10px; padding:12px; flex:1; min-height:0;}
    .row{display:flex; gap:10px; align-items:center;} .row > *{flex:1}
    .btn{appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); padding:9px 10px; border-radius:12px; cursor:pointer; font-weight:650;}
    .btn:hover{border-color:#2d4364}
    .btn.primary{border-color:rgba(110,168,255,.35); background:rgba(110,168,255,.12)}
    .btn.danger{border-color:rgba(255,92,122,.35); background:rgba(255,92,122,.10)}
    .btn.small{padding:7px 9px; font-size:12px; border-radius:10px}
    .pill{font-family:var(--mono); font-size:11px; color:var(--text); background:rgba(244,195,0,.12); border:1px solid rgba(244,195,0,.28); padding:4px 8px; border-radius:999px; display:inline-flex; align-items:center; gap:6px;}
    input[type="text"], input[type="number"], textarea, select{ width:100%; background:rgba(0,0,0,.25); border:1px solid var(--line); color:var(--text); border-radius:12px; padding:9px 10px; outline:none; }
    textarea{min-height:70px; resize:vertical}
    .muted{color:var(--muted)} .mono{font-family:var(--mono)} .divider{height:1px; background:var(--line); margin:10px 0}
    .sessions{ display:flex; flex-direction:column; gap:8px; overflow:auto; padding-right:6px; padding-bottom:8px; flex:1; min-height:0; }
    .session-item{border:1px solid var(--line); border-radius:14px; padding:10px 10px; cursor:pointer; background:rgba(0,0,0,.18);}
    .session-item:hover{border-color:#2d4364}
    .session-item.active{border-color:rgba(110,168,255,.55); background:rgba(110,168,255,.08)}
    .session-item .name{font-weight:800; font-size:13px}
    .session-item .meta{display:flex; gap:8px; margin-top:6px; flex-wrap:wrap}
    .badge{font-size:11px; color:var(--muted); border:1px solid var(--line); padding:3px 7px; border-radius:999px; background:rgba(255,255,255,.02);}
    .main{display:grid; grid-template-rows:auto 1fr; gap:14px;}
    .content{padding:12px; overflow:auto; height: calc(100vh - 140px);}
    .workout{border:1px solid var(--line); border-radius:16px; background:rgba(0,0,0,.18); margin-bottom:10px; overflow:hidden;}
    .workout-head{padding:12px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; cursor:pointer;}
    .workout-head:hover{background:rgba(255,255,255,.02)}
    .workout-title{font-weight:900}
    .workout-sub{color:var(--muted); font-size:12px; margin-top:3px}
    .workout-body{padding:12px; border-top:1px solid var(--line); display:none}
    .workout.open .workout-body{display:block}
    .grid{display:grid; grid-template-columns: 64px minmax(7ch,1fr) minmax(7ch,1fr) minmax(7ch,1fr) 52px; gap:8px; align-items:center; min-width:0;}
    .grid .h{color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.12em}
    .grid > *{min-width:0;}
    .grid input[type="text"], .grid input[type="number"]{width:100%; min-width:0; max-width:100%; font-family:var(--mono); font-size:16px; padding:9px 10px;}
    .grid input[type="checkbox"]{ transform: scale(1.15); }
    .set-row{padding:8px; border:1px solid rgba(255,255,255,.05); border-radius:14px; background:rgba(255,255,255,.02); margin-top:8px;}
    .done{border-color:rgba(53,208,127,.35); background:rgba(53,208,127,.06);}
    .footer-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .timer-box{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .timer{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--line); border-radius:16px; background:rgba(0,0,0,.18);}
    .timer .time{font-family:var(--mono); font-size:18px; letter-spacing:.06em; min-width:92px; text-align:center;}
    .small-note{font-size:12px; color:var(--muted); line-height:1.35}
    .two-col{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    
    #mobileBrowseRow { display:none; }
    .drawer{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:9999; }
    .drawer.open{ display:block; }
    .drawer .sheet{ position:absolute; left:0; right:0; bottom:0; max-height:85vh; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius: 18px 18px 0 0; box-shadow:var(--shadow); padding:12px; display:flex; flex-direction:column; gap:10px; }
    #authAvatar{width:32px;height:32px;border-radius:999px;border:1px solid var(--line);display:none;object-fit:cover;}
    .authBar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    
    /* Save indicator */
    #saveStatus { position:fixed; bottom:20px; right:20px; background:rgba(0,0,0,0.7); color:var(--accent); padding:6px 12px; border-radius:20px; font-size:12px; font-weight:bold; opacity:0; transition:opacity 0.2s; pointer-events:none; z-index:9999; }
    #saveStatus.saving { opacity:1; background:rgba(255,200,0,0.8); color:black; }
    #saveStatus.saved { opacity:0; transition:opacity 1s; background:rgba(53,208,127,0.8); color:black; }
    
    #errorBox { display:none; position:fixed; top:0; left:0; right:0; background:rgba(255,0,0,0.95); color:white; padding:20px; z-index:99999; font-family:monospace; white-space:pre-wrap; }
    
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; height:auto;}
      .content{height:auto; max-height:none;}
      .sessions{max-height:none;}
      .two-col{grid-template-columns:1fr;}
      #mobileBrowseRow{ display:flex; }
      #sessions{ display:none; }
      .grid{display:grid; grid-template-columns: 52px 7ch 7ch 7ch 52px; gap:6px; align-items:center; min-width:0;}
      .grid input[type="text"], .grid input[type="number"]{width:100%; min-width:0; max-width:100%; font-family:var(--mono); font-size:16px; padding:9px 10px;}
      .grid input[type="checkbox"]{ transform: scale(1.15); justify-self:center; }
      #authStatus{display:none;}
      .authBar{gap:8px;}
    }
    
    .stats-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    .stat{ border:1px solid var(--line); border-radius:14px; padding:10px 12px; background:rgba(0,0,0,.18); }
    .statv{ font-family:var(--mono); font-size:20px; font-weight:900; margin-top:6px; letter-spacing:.02em; }
    #planSessionChart{ width:100%; height:260px; display:block; }
    .toplist{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
    .topitem{display:flex;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:8px 10px;background:rgba(255,255,255,.02);}
    .topitem b{font-weight:900;}
    @media (max-width: 980px){ .stats-grid{grid-template-columns: 1fr;} #planSessionChart{height:220px;} }
  </style>
</head>
<body>
  <div id="errorBox"></div>
  <div id="saveStatus">Saved</div>

  <div class="app">
    <div class="card">
      <header>
        <div>
          <div class="title">BOLT</div>
          <div class="subtitle" id="subtitle">Local logs • static plan</div>
        </div>
        <div class="pill" id="sessionCount">0 sessions</div>
      </header>

      <div class="stack">
        <button class="btn danger small" onclick="emergencyReset()" style="align-self:flex-start;">⚠️ Reset App</button>

        <div class="two-col">
          <div>
            <label class="muted" for="programSelect">Program</label>
            <select id="programSelect"></select>
          </div>
          <div>
            <label class="muted" for="sessionSelect">Session</label>
            <select id="sessionSelect"></select>
          </div>
        </div>
        <div class="row">
          <input id="search" type="text" placeholder="Search sessions/workouts…" />
        </div>

        <div class="row">
          <button class="btn primary" id="reloadBtn">Reload plan</button>
          <button class="btn" id="openPlanStats" type="button">Plan stats</button>
          <button class="btn danger" id="clearBtn">Clear logs</button>
        </div>

        <div class="timer-box">
          <div class="timer">
            <div class="time" id="timerDisplay">00:00</div>
            <button class="btn small" id="timerStart">Start</button>
            <button class="btn small" id="timerPause">Pause</button>
            <button class="btn small" id="timerReset">Reset</button>
          </div>
          <select id="preset">
            <option value="60">Rest 60s</option>
            <option value="90">Rest 90s</option>
            <option value="120" selected>Rest 120s</option>
            <option value="180">Rest 180s</option>
          </select>
          <input id="customSeconds" type="number" min="5" step="5" placeholder="Custom seconds" />
          <button class="btn small" id="setCustom">Set</button>
        </div>

        <div class="small-note" id="planHint">
          Put your combined program JSON files in <span class="mono">/data</span>, then edit <span class="mono">PROGRAM_SOURCES</span> in this file.
        </div>

        <div class="row" id="mobileBrowseRow">
          <button class="btn primary" id="openSessions" type="button">Browse sessions</button>
        </div>

        <div class="divider"></div>
        <div class="sessions" id="sessions"></div>

        <div class="footer-actions">
          <button class="btn" id="exportLogs">Export logs (JSON)</button>
          <button class="btn" id="importLogs">Import logs</button>
          <button class="btn" id="exportCSV">Export logs (CSV)</button>
        </div>
        <input id="importFile" type="file" accept=".json,application/json" style="display:none" />
      </div>
    </div>

    <div class="main">
      <div class="card">
        <header>
          <div>
            <div class="title" id="activeTitle">Loading…</div>
            <div class="subtitle" id="activeMeta">—</div>
            <div class="subtitle" id="activeFunFact" style="margin-top:6px;opacity:.9;font-weight:500;color:var(--accent);"></div>
          </div>
          <div class="authBar">
            <div class="pill" id="activePill">—</div>
            <img id="authAvatar" alt="profile" />
            <span class="pill" id="authStatus" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Not signed in</span>
            <button class="btn small primary" id="signInGoogle" type="button">Sign in</button>
            <button class="btn small" id="signOut" type="button" style="display:none">Sign out</button>
          </div>
        </header>
        <div class="content" id="content"></div>
      </div>
    </div>
  </div>

  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
        <div style="font-weight:900;">Select a session</div>
        <button class="btn small" id="closeSessions" type="button" style="max-width:120px;">Close</button>
      </div>
      <div class="sessions" id="sessionsDrawer" style="max-height:70vh; overflow:auto;"></div>
    </div>
  </div>

  <div class="drawer" id="planStatsModal" aria-hidden="true">
    <div class="sheet" style="max-height:88vh;">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
        <div style="font-weight:900;">Plan stats</div>
        <button class="btn small" id="closePlanStats" type="button" style="max-width:120px;">Close</button>
      </div>
      <div class="stats-grid">
        <div class="stat"><div class="muted">Total volume</div><div class="statv"><span id="planTotalVolume">0</span> <span class="muted">kg•reps</span></div></div>
        <div class="stat"><div class="muted">Logged sessions</div><div class="statv" id="planLoggedSessions">0</div></div>
        <div class="stat"><div class="muted">Logged sets</div><div class="statv" id="planLoggedSets">0</div></div>
        <div class="stat"><div class="muted">Unique exercises</div><div class="statv" id="planUniqueExercises">0</div></div>
      </div>
      <div class="divider"></div>
      <div class="small-note"><b>Volume by session (top)</b></div>
      <canvas id="planSessionChart" width="900" height="260" style="width:100%;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);"></canvas>
      <div class="divider"></div>
      <div class="small-note"><b>Top exercises</b></div>
      <div class="toplist" id="planTopExercises"></div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/index-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // --- EMERGENCY ERROR HANDLER ---
  window.addEventListener('error', function(e) {
    const box = document.getElementById('errorBox');
    if(box) {
      box.style.display = 'block';
      box.textContent += `Error: ${e.message}\n`;
    }
  });

  function emergencyReset() {
    if(!confirm("Reset app? This clears cached code. Your logs are safe.")) return;
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) { registration.unregister(); }
        window.location.reload(true);
      });
    } else {
      window.location.reload(true);
    }
  }

  // --- CONFIG ---
  const PROGRAM_SOURCES = [
    { name: "Hypertrophy", url: "data/hypertrophy.json" },
    { name: "Starting Strongman", url: "data/starting_strongman.json" },
    { name: "Static Monster", url: "data/static_monster.json" },
  ];

  const SUPABASE_URL = "https://redxigdkdjyxaofmutlv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZHhpZ2RrZGp5eGFvZm11dGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMjI5MTQsImV4cCI6MjA4MDc5ODkxNH0.24RNF4dKYNcKkAESiYNbA4_3Fvt-zTCFe5jCjR4vdn0";
  const supabase = (typeof window.supabase !== 'undefined' && SUPABASE_ANON_KEY.length > 20) 
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) 
    : null;

  const LS_KEY = "mst_tracker_logs_v2";
  const PREFS_KEY = "mst_tracker_prefs_v1";
  let cloudSaveTimer = null;
  const CLOUD_SAVE_DEBOUNCE_MS = 800;

  // --- STATE ---
  const state = {
    programs: [],
    programById: new Map(),
    sessionsById: new Map(),
    workoutsById: new Map(),
    activeProgramId: null,
    activeSessionId: null,
    logs: {}, 
    timer: { total: 120, left: 120, running: false, t: null },
    funFacts: []
  };

  // --- HELPERS ---
  function resolveReps(repsStr, setIndex) {
    if (!repsStr) return "";
    const s = String(repsStr);
    if (s.includes(",")) {
      const parts = s.split(",").map(p => p.trim());
      return parts[setIndex] || parts[parts.length - 1];
    }
    return s;
  }

  function uid(str){
    let h = 2166136261;
    for (let i=0; i<str.length; i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return "id_" + (h >>> 0).toString(16);
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  
  function cleanWorkoutTitle(title, programName){
    let t = String(title || "").trim();
    if (!t) return t;
    if (programName){
      const progRe = new RegExp("\\s*-\\s*" + String(programName).replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "\\b.*$", "i");
      if (progRe.test(t)) t = t.replace(progRe, "").trim();
    }
    t = t.replace(/\s*-\s*WEEK\s*\d+\b.*$/i, "").trim();
    t = t.replace(/\s*-\s*Week\s*\d+\b.*$/i, "").trim();
    t = t.replace(/\s*-\s*SESSION\s*\d+\b.*$/i, "").trim();
    return t;
  }

  function toIntMaybe(v){
    if (v == null) return null;
    const s = String(v).trim();
    const n = parseInt(s, 10);
    return Number.isFinite(n) ? n : null;
  }

  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  // --- TIMER LOGIC ---
  function setTimer(sec){
    state.timer.total = sec;
    state.timer.left = sec;
    state.timer.running = false;
    state.timer.endAt = null;
    stopTimerLoop();
    renderTimer();
  }

  function renderTimer(){
    if (state.timer.running && state.timer.endAt){
      const now = Date.now();
      state.timer.left = Math.max(0, Math.ceil((state.timer.endAt - now) / 1000));
    }
    const elDisplay = document.getElementById("timerDisplay");
    if(elDisplay) elDisplay.textContent = fmtTime(state.timer.left);
  }

  function stopTimerLoop(){
    if (state.timer.t){
      clearInterval(state.timer.t);
      state.timer.t = null;
    }
  }

  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = 880;
      g.gain.value = 0.05;
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 250);
    }catch{}
  }

  function tickTimer(){
    if (!state.timer.running) return;
    const now = Date.now();
    const left = Math.max(0, Math.ceil((state.timer.endAt - now) / 1000));
    state.timer.left = left;
    renderTimer();

    if (left <= 0){
      state.timer.running = false;
      state.timer.endAt = null;
      stopTimerLoop();
      beep();
    }
  }

  function startTimer(){
    if (state.timer.left <= 0) state.timer.left = state.timer.total;
    state.timer.endAt = Date.now() + state.timer.left * 1000;
    state.timer.running = true;
    if (!state.timer.t) state.timer.t = setInterval(tickTimer, 250);
    tickTimer();
  }

  function pauseTimer(){
    if (!state.timer.running) return;
    renderTimer();
    state.timer.running = false;
    state.timer.endAt = null;
    stopTimerLoop();
  }

  function resetTimer(){
    setTimer(state.timer.total);
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") tickTimer();
  });

  // --- STORAGE ---
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  function touchLogs() {
    if (state.logs) state.logs._updatedAt = Date.now();
  }

  function showSaveIndicator(){
    const el = document.getElementById("saveStatus");
    if(el) {
      el.textContent = "Saved";
      el.classList.add("saved");
      el.classList.remove("saving");
      setTimeout(()=> {
        el.classList.remove("saved");
      }, 1000);
    }
  }

  // KEY FIX: Direct write to LocalStorage (Sync) + IDB (Async) on every change
  function saveLogsInstant() {
    try {
      touchLogs();
      // 1. Sync Save (Blocks browser from freezing)
      localStorage.setItem(LS_KEY, JSON.stringify(state.logs));
      showSaveIndicator();
      
      // 2. Async backups
      if (typeof idbKeyval !== 'undefined') idbKeyval.set(LS_KEY, state.logs).catch(()=>{});
      scheduleCloudSave();
    } catch (e) { console.error("Save failed", e); }
  }

  // DEBOUNCED version for Restore (prevents spamming on restore)
  const saveLogsDebounced = debounce(() => {
     // No-op here, mainly for older references. All inputs now use Instant.
  }, 500);

  // --- EVENT LISTENERS FOR SYNC ---
  // When resuming, force reload from disk to ensure memory matches reality
  let reloadTimer = null;
  function safeReload() {
    if (reloadTimer) clearTimeout(reloadTimer);
    reloadTimer = setTimeout(() => {
      console.log("Safe Reload triggered");
      loadLogsAsync();
    }, 200); // 200ms grace period for browser to wake up
  }

  window.addEventListener("focus", safeReload);
  
  // Backup on freeze
  window.addEventListener("pagehide", saveLogsInstant);
  window.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") saveLogsInstant();
    if (document.visibilityState === "visible") safeReload(); 
  });

  // --- CUSTOM EXERCISES ---
  function sessionKey(session){ return `${session.programName}|||${session.title}`; }
  
  function ensureCustomStore(){
    if (typeof state.logs !== "object" || state.logs === null) state.logs = {};
    if (!state.logs.__custom_sessions) state.logs.__custom_sessions = {};
  }
  
  function getCustomWorkouts(session){
    ensureCustomStore();
    const key = sessionKey(session);
    return state.logs.__custom_sessions[key] || [];
  }
  
  function addCustomWorkout(session, title, setCount, reps){
    ensureCustomStore();
    const key = sessionKey(session);
    const arr = getCustomWorkouts(session);
    arr.push({
      title: String(title||"").trim(),
      sets: Number(setCount)||3,
      reps: String(reps||"").trim(),
      notes: [],
      created_at: new Date().toISOString()
    });
    state.logs.__custom_sessions[key] = arr;
    saveLogsInstant();
    try { renderAll(); } catch(e){ console.error("Render fail", e); }
  }

  function getAllWorkoutsForSession(session){
    const base = Array.isArray(session?.workouts) ? session.workouts : [];
    const custom = getCustomWorkouts(session).map((cw, i) => ({
      id: uid(`${session.programName}::${session.title}::custom::${i}::${cw.title}`),
      title: cw.title,
      index: base.length + i,
      setsStr: String(cw.sets),
      repsStr: String(cw.reps || ""),
      setCount: Number(cw.sets) || 3,
      targetReps: String(cw.reps || "").trim(),
      notes: Array.isArray(cw.notes) ? cw.notes : [],
      _isCustom: true,
      _customIndex: i
    }));
    return [...base, ...custom];
  }

  function ensureWorkoutLog(session, workout, workoutIndex){
    const k = `${session.programName}|||${session.title}|||${workoutIndex}|||${workout.title}`;
    let wlog = state.logs[k];
    if(!wlog){
      wlog = {
        program: session.programName, session: session.title, workout: workout.title, workoutIndex,
        requiredSets: workout.setCount, requiredReps: workout.targetReps,
        sets: Array.from({length: workout.setCount}, (_,i) => ({
          set: i+1, targetReps: resolveReps(workout.targetReps, i),
          weight:"", reps:"", done:false, note:""
        })),
        workoutNote:""
      };
      state.logs[k] = wlog;
    } else {
      if(!Array.isArray(wlog.sets)) wlog.sets=[];
      while(wlog.sets.length < workout.setCount){
        const i = wlog.sets.length;
        wlog.sets.push({
          set: i+1, targetReps: resolveReps(workout.targetReps, i),
          weight:"", reps:"", done:false, note:""
        });
      }
    }
    return wlog;
  }

  function countWorkoutLogged(programName, sessionTitle, workout, workoutIndex){
    const k = `${programName}|||${sessionTitle}|||${workoutIndex}|||${workout.title}`;
    const wlog = state.logs[k];
    if(!wlog || !Array.isArray(wlog.sets)) return false;
    return wlog.sets.some(r => (r.weight || r.reps || r.done));
  }

  function countLoggedInSession(session){
    let done = 0;
    getAllWorkoutsForSession(session).forEach((w,idx)=>{
      if(countWorkoutLogged(session.programName, session.title, w, idx)) done++;
    });
    return done;
  }

  // --- AUTH & CLOUD ---
  function scheduleCloudSave(){
    if(!supabase || !state._user) return;
    if(cloudSaveTimer) clearTimeout(cloudSaveTimer);
    cloudSaveTimer = setTimeout(()=>cloudSaveNow().catch(console.error), CLOUD_SAVE_DEBOUNCE_MS);
  }
  async function cloudSaveNow(){
    if(!supabase || !state._user) return;
    const payload = { user_id: state._user.id, logs: state.logs, updated_at: new Date().toISOString() };
    const {error} = await supabase.from("user_logs").upsert(payload, {onConflict:"user_id"});
    if(error) throw error;
  }
  async function cloudLoad(){
    if(!supabase || !state._user) return;
    const {data, error} = await supabase.from("user_logs").select("logs").eq("user_id", state._user.id).maybeSingle();
    if(error){ console.warn("cloudLoad error", error); return; }
    const cloudLogs = data?.logs||{};
    if(typeof cloudLogs!=="object" || cloudLogs===null) return;
    
    // Cloud Merge strategy
    const localTs = state.logs._updatedAt || 0;
    const cloudTs = cloudLogs._updatedAt || 0;
    if(cloudTs > localTs) {
       state.logs = cloudLogs;
       saveLogsInstant();
       try { renderAll(); } catch(e){} 
    }
  }
  function setAuthUI(signedIn, email){
    const elStatus = document.getElementById("authStatus");
    const elIn = document.getElementById("signInGoogle");
    const elOut = document.getElementById("signOut");
    const elAv = document.getElementById("authAvatar");
    if (!elStatus) return;
    const meta = state._user?.user_metadata || {};
    const avatar = meta.avatar_url || meta.picture || "";
    if (signedIn){
      elStatus.textContent = email ? email : "Signed in";
      elIn.style.display="none"; elOut.style.display="inline-flex";
      if(elAv && avatar){ elAv.src=avatar; elAv.style.display="inline-block"; }
      else if(elAv) elAv.style.display="none";
    } else {
      elStatus.textContent = "Not signed in";
      elIn.style.display="inline-flex"; elOut.style.display="none";
      if(elAv) elAv.style.display="none";
    }
  }
  async function initAuth(){
    if(!supabase){ setAuthUI(false); return; }
    const {data:sessData} = await supabase.auth.getSession();
    state._user = sessData?.session?.user || null;
    setAuthUI(!!state._user, state._user?.email);
    if(state._user){ await cloudLoad(); try{renderAll();}catch(e){} }
    supabase.auth.onAuthStateChange(async (_event, session)=>{
      state._user = session?.user || null;
      setAuthUI(!!state._user, state._user?.email);
      if(state._user){ await cloudLoad(); try{renderAll();}catch(e){} scheduleCloudSave(); }
    });
    document.getElementById("signInGoogle")?.addEventListener("click", async()=>{
      const redirectTo = new URL(".", window.location.href).toString();
      const {error} = await supabase.auth.signInWithOAuth({provider:"google", options:{redirectTo}});
      if(error) alert("Sign-in failed: "+error.message);
    });
    document.getElementById("signOut")?.addEventListener("click", async()=>{
      await supabase.auth.signOut();
      state._user = null;
      setAuthUI(false);
      state.logs = {};
      if (typeof idbKeyval !== 'undefined') await idbKeyval.del(LS_KEY);
      localStorage.removeItem(LS_KEY);
      try{renderAll();}catch(e){}
      alert("Signed out.");
    });
  }

  // --- RENDERING ---
  function renderProgramSelect(){
    const elProg = document.getElementById("programSelect");
    elProg.innerHTML = state.programs.map(p =>
      `<option value="${p.id}" ${p.id===state.activeProgramId?"selected":""}>${escapeHtml(p.name)}</option>`
    ).join("");
  }

  function renderSessionSelect(){
    const elSess = document.getElementById("sessionSelect");
    const p = state.programById.get(state.activeProgramId);
    const sessions = p?.sessions || [];
    elSess.innerHTML = sessions.map(s =>
      `<option value="${s.id}" ${s.id===state.activeSessionId?"selected":""}>${escapeHtml(s.title)}</option>`
    ).join("");
  }

  function renderSessionsList(){
    const elList = document.getElementById("sessions");
    const elCount = document.getElementById("sessionCount");
    const p = state.programById.get(state.activeProgramId);
    const q = document.getElementById("search").value.trim().toLowerCase();
    
    const sessions = (p?.sessions || []).filter(s => {
      if (!q) return true;
      if (s.title.toLowerCase().includes(q)) return true;
      return s.workouts.some(w => w.title.toLowerCase().includes(q));
    });

    elCount.textContent = `${(p?.sessions||[]).length} sessions`;
    
    elList.innerHTML = sessions.map(s => {
      const total = s.workouts.length;
      const done = countLoggedInSession(s);
      const active = s.id === state.activeSessionId ? "active" : "";
      return `
        <div class="session-item ${active}" onclick="pickSession('${s.id}')">
          <div class="name">${escapeHtml(s.title)}</div>
          <div class="meta"><span class="badge">${total} workouts</span><span class="badge">${done}/${total} logged</span></div>
        </div>
      `;
    }).join("");
  }

  function renderSetRow(session, workout, workoutIndex, row){
    const doneClass = row.done ? "done" : "";
    const smartTarget = resolveReps(workout.targetReps, row.set - 1);
    let displayValue = row.targetReps;
    if (!displayValue || displayValue === workout.targetReps || displayValue.includes(",")) {
      displayValue = smartTarget;
    }

    return `
      <div class="set-row ${doneClass}">
        <div class="grid">
          <div class="mono">#${row.set}</div>
          <input type="text" placeholder="${escapeHtml(smartTarget)}" value="${escapeHtml(displayValue)}" oninput="updateSet(this, ${workoutIndex}, ${row.set}, 'targetReps')">
          <input type="text" inputmode="decimal" placeholder="kg" value="${escapeHtml(row.weight||"")}" oninput="updateSet(this, ${workoutIndex}, ${row.set}, 'weight')">
          <input type="text" inputmode="numeric" placeholder="reps" value="${escapeHtml(row.reps||"")}" oninput="updateSet(this, ${workoutIndex}, ${row.set}, 'reps')">
          <input type="checkbox" ${row.done?"checked":""} onchange="updateSet(this, ${workoutIndex}, ${row.set}, 'done')">
        </div>
        <div style="margin-top:8px">
          <input type="text" placeholder="Set note (optional)" value="${escapeHtml(row.note||"")}" oninput="updateSet(this, ${workoutIndex}, ${row.set}, 'note')">
        </div>
      </div>
    `;
  }

  function renderActiveSession(){
    try {
      const elMain = document.getElementById("content");
      const elHead = document.getElementById("activeTitle");
      const session = state.sessionsById.get(state.activeSessionId);
      
      if (!session){
        elHead.textContent = "No session loaded";
        document.getElementById("activeMeta").textContent = "Check sources";
        document.getElementById("activePill").textContent = "—";
        elMain.innerHTML = `<div class="muted">Nothing selected.</div>`;
        return;
      }

      elHead.textContent = `${session.programName} • ${session.title}`;
      updateActiveProgress();
      
      try { updateSessionFunFact(); } catch(e){ console.warn("FunFact error", e); }

      const allWorkouts = getAllWorkoutsForSession(session);
      const workoutsHtml = allWorkouts.map((w, idx) => {
        const wlog = ensureWorkoutLog(session, w, idx);
        const logged = countWorkoutLogged(session.programName, session.title, w, idx);
        const badge = logged ? '<span class="pill" style="margin-left:8px;border-color:rgba(53,208,127,.35);background:rgba(53,208,127,.10);color:#c8ffe2">logged</span>' : '';
        const requiredLabel = `Required: Sets ${escapeHtml(w.setsStr||String(w.setCount))} • Reps ${escapeHtml(w.repsStr||w.targetReps||"")}`;
        
        const deleteBtn = w._isCustom 
          ? `<button class="btn danger small" onclick="removeCustomWorkout(${w._customIndex}); event.stopPropagation();" style="margin-right:8px;">Remove</button>`
          : '';

        return `
          <div class="workout" data-wi="${idx}">
            <div class="workout-head" onclick="toggleWorkout(this)">
              <div>
                <div class="workout-title" id="title_${idx}">${escapeHtml(cleanWorkoutTitle(w.title, session.programName))} ${badge}</div>
                <div class="workout-sub">${requiredLabel}</div>
              </div>
              <div style="display:flex;align-items:center;">
                ${deleteBtn}
                <button class="btn small">Toggle</button>
              </div>
            </div>
            <div class="workout-body">
              ${w.notes?.length ? `<div class="small-note"><b>Plan notes</b><br>${w.notes.map(n=>escapeHtml(n)).join("<br>")}</div><div class="divider"></div>` : ""}
              <div class="grid"><div class="h">Set</div><div class="h">Target</div><div class="h">Kg</div><div class="h">Reps</div><div class="h">Done</div></div>
              <div id="sets_${idx}">${wlog.sets.map(r=>renderSetRow(session,w,idx,r)).join("")}</div>
              <div class="footer-actions">
                <button class="btn small" onclick="modSet(${idx}, 1)">+ Set</button>
                <button class="btn small danger" onclick="modSet(${idx}, -1)">− Set</button>
                <button class="btn small" onclick="startRest(120)">Start 120s rest</button>
                <button class="btn small" onclick="startRest(90)">Start 90s rest</button>
                <button class="btn small" onclick="startRest(60)">Start 60s rest</button>
              </div>
              <div class="divider"></div>
              <label class="muted">Workout notes</label>
              <textarea oninput="updateWorkoutNote(this, ${idx})" placeholder="Notes...">${escapeHtml(wlog.workoutNote||"")}</textarea>
            </div>
          </div>
        `;
      }).join("");

      const addBoxHtml = `
        <div class="workout">
          <div class="workout-head" onclick="toggleWorkout(this)">
            <div><div class="workout-title">Add exercise</div><div class="workout-sub">Custom exercise</div></div>
            <button class="btn small">Toggle</button>
          </div>
          <div class="workout-body">
            <div class="grid" style="grid-template-columns: 1fr 90px 120px;">
              <div class="h">Exercise</div><div class="h">Sets</div><div class="h">Target reps</div>
              <input id="customTitle" type="text" placeholder="e.g. Arnold press" />
              <input id="customSets" type="number" min="1" step="1" value="3" />
              <input id="customReps" type="text" placeholder="e.g. 8-12" />
            </div>
            <div class="footer-actions"><button class="btn small primary" onclick="handleCustomAdd()">Add</button></div>
          </div>
        </div>
      `;
      elMain.innerHTML = workoutsHtml + addBoxHtml;
    } catch(e) {
      console.error("Render Error:", e);
      document.getElementById("content").innerHTML = `<div class="small-note" style="color:red">Error rendering session: ${e.message}</div>`;
    }
  }

  function updateActiveProgress(){
    const session = state.sessionsById.get(state.activeSessionId);
    if (!session) return;
    const all = getAllWorkoutsForSession(session);
    const total = all.length;
    let done = 0;
    all.forEach((w, idx) => {
      if (countWorkoutLogged(session.programName, session.title, w, idx)) done++;
    });
    document.getElementById("activeMeta").textContent = `Workouts: ${total} • Logged: ${done}/${total}`;
    document.getElementById("activePill").textContent = `${done}/${total}`;
  }

  function renderAll(){
    try {
      renderProgramSelect();
      renderSessionSelect();
      renderSessionsList();
      renderActiveSession();
    } catch(e){ console.error("Critical Render Failure", e); }
  }

  // --- ACTIONS (Global Window Scope) ---
  window.pickSession = (sid) => {
    state.activeSessionId = sid;
    savePrefs();
    renderAll();
    const drawer = document.getElementById("drawer");
    if(drawer.classList.contains("open")){
       drawer.classList.remove("open"); drawer.setAttribute("aria-hidden", "true");
    }
    document.getElementById("content")?.scrollIntoView({ behavior: "smooth", block: "start" });
  };

  window.toggleWorkout = (el) => {
    if(event.target.tagName !== "BUTTON") el.closest('.workout').classList.toggle('open');
  };

  window.modSet = (wIdx, delta) => {
    const session = state.sessionsById.get(state.activeSessionId);
    const w = getAllWorkoutsForSession(session)[wIdx];
    const wlog = ensureWorkoutLog(session, w, wIdx);
    if(delta > 0) {
      wlog.sets.push({
        set: wlog.sets.length+1, targetReps: resolveReps(w.targetReps, wlog.sets.length),
        weight:"", reps:"", done:false, note:""
      });
    } else if (wlog.sets.length > 1) {
      wlog.sets.pop();
    }
    saveLogsInstant();
    renderActiveSession();
  };

  window.startRest = (sec) => { setTimer(sec); startTimer(); };

  window.updateWorkoutNote = (el, wIdx) => {
    const session = state.sessionsById.get(state.activeSessionId);
    const w = getAllWorkoutsForSession(session)[wIdx];
    const wlog = ensureWorkoutLog(session, w, wIdx);
    wlog.workoutNote = el.value;
    saveLogsInstant(); 
  };

  window.updateSet = (el, wIdx, setNum, field) => {
    const session = state.sessionsById.get(state.activeSessionId);
    const w = getAllWorkoutsForSession(session)[wIdx];
    const wlog = ensureWorkoutLog(session, w, wIdx);
    const row = wlog.sets.find(r => r.set === setNum);
    if(!row) return;

    if(field === 'done') {
      row.done = el.checked;
      el.closest('.set-row').classList.toggle('done', row.done);
      saveLogsInstant();
      const isLogged = wlog.sets.some(s=>s.done||s.weight||s.reps);
      const tEl = document.getElementById(`title_${wIdx}`);
      if(tEl) {
         const cleanTitle = escapeHtml(cleanWorkoutTitle(w.title, session.programName));
         const badge = isLogged ? '<span class="pill" style="margin-left:8px;border-color:rgba(53,208,127,.35);background:rgba(53,208,127,.10);color:#c8ffe2">logged</span>' : '';
         tEl.innerHTML = `${cleanTitle} ${badge}`;
      }
      updateActiveProgress();
    } else {
      state.logs._updatedAt = Date.now();
      row[field] = el.value;
      saveLogsInstant();
    }
  };

  window.handleCustomAdd = () => {
    const session = state.sessionsById.get(state.activeSessionId);
    const title = document.getElementById("customTitle")?.value||"";
    const sets = parseInt(document.getElementById("customSets")?.value||"3",10);
    const reps = document.getElementById("customReps")?.value||"";
    if(!String(title).trim()) return alert("Enter exercise name.");
    addCustomWorkout(session, title, sets, reps);
    renderAll();
  };

  window.removeCustomWorkout = (index) => {
    if(!confirm("Remove this custom exercise?")) return;
    const session = state.sessionsById.get(state.activeSessionId);
    const key = sessionKey(session);
    const arr = state.logs.__custom_sessions[key];
    if(arr && arr[index]) {
      arr.splice(index, 1);
      saveLogsInstant();
      renderAll();
    }
  };

  // --- FUN FACTS LOGIC ---
  async function loadFunFacts() {
    try {
      const res = await fetch("fun_facts.json");
      if(res.ok) state.funFacts = await res.json();
    } catch(e) { console.warn("Failed to load fun facts", e); }
  }

  function numFloat(v){ const n=parseFloat(String(v).trim()); return Number.isFinite(n)?n:null; }
  function numInt(v){ const n=parseInt(String(v).trim(),10); return Number.isFinite(n)?n:null; }
  function fmtInt(n){ try{return new Intl.NumberFormat().format(Math.round(n));}catch{return String(Math.round(n));} }
  function hashInt(str){
    let h=2166136261;
    for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); }
    return (h>>>0);
  }

  function sessionLogPrefix(session){ return `${session.programName}|||${session.title}|||`; }

  function computeSessionVolumeKg(session){
    if (!session) return 0;
    const prefix = sessionLogPrefix(session);
    let total = 0;
    for (const k of Object.keys(state.logs || {})){
      if (k.startsWith("__") || !k.startsWith(prefix)) continue;
      const wlog = state.logs[k];
      const sets = Array.isArray(wlog?.sets) ? wlog.sets : [];
      for (const s of sets){
        const w = numFloat(s?.weight);
        const r = numInt(s?.reps);
        if (w != null && r != null) total += (w * r);
      }
    }
    return total;
  }

  function updateSessionFunFact(){
    const session = state.sessionsById.get(state.activeSessionId);
    const elFact = document.getElementById("activeFunFact");
    if (!elFact || !session) {
      if(elFact) elFact.textContent = "";
      return;
    }
    const kg = computeSessionVolumeKg(session);
    if (!kg || kg <= 0){ elFact.textContent = ""; return; }
    
    // Default picks if file fails
    let picks = [
      { label: '3.5" floppy disks', unitKg: 0.02 },
      { label: 'Raspberry Pi boards', unitKg: 0.045 },
      { label: 'desktop PCs', unitKg: 8.0 }
    ];
    if (state.funFacts && state.funFacts.length > 0) picks = state.funFacts;

    const h = hashInt(`${session.programName}::${session.title}`);
    const pick = picks[h % picks.length];
    const count = Math.max(1, Math.round(kg / pick.unitKg));
    elFact.textContent = `You lifted ${fmtInt(kg)}kg today — about the same weight as ${fmtInt(count)} ${pick.label}.`;
  }

  function savePrefs() {
    try {
      const prefs = {
        programId: state.activeProgramId,
        sessionId: state.activeSessionId
      };
      localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
    } catch (e) {
      console.warn("Failed to save prefs", e);
    }
  }

  async function loadAllPrograms(){
    try {
      state.programs=[];
      for(const src of PROGRAM_SOURCES){
        const res = await fetch(src.url, {cache:"no-store"});
        if(!res.ok) throw new Error(res.statusText);
        const raw = await res.json();
        
        const prog = { 
          id: uid(`program::${raw.program}`), 
          name: raw.program, 
          sessions: (raw.sessions||[]).map((s,si)=>{
             const sTitle = s.session || `Session ${si+1}`;
             return {
               id: uid(`program::${raw.program}::session::${sTitle}::${si}`),
               title: sTitle,
               programName: raw.program,
               workouts: (s.workouts||[]).map((w,wi)=>{
                 const wTitle = w.title || `Workout ${wi+1}`;
                 const sStr = w.sets??""; const rStr=w.reps??"";
                 let tReps = String(rStr).trim();
                 if (tReps.toLowerCase() === cleanWorkoutTitle(wTitle, raw.program).toLowerCase()) tReps = "";
                 return {
                   id: uid(`w::${sTitle}::${wi}::${wTitle}`),
                   title: wTitle,
                   setCount: toIntMaybe(sStr) ?? 3,
                   targetReps: tReps,
                   setsStr: String(sStr), repsStr: String(rStr),
                   notes: Array.isArray(w.notes)?w.notes:[]
                 };
               })
             };
          })
        };
        state.programs.push(prog);
      }
      state.programById.clear(); state.sessionsById.clear();
      for(const p of state.programs){
        state.programById.set(p.id, p);
        for(const s of p.sessions) state.sessionsById.set(s.id, s);
      }
      let prefs = {};
      try{ prefs = JSON.parse(localStorage.getItem(PREFS_KEY)||"{}"); }catch{}
      if(prefs.programId && state.programById.has(prefs.programId)) state.activeProgramId = prefs.programId;
      else state.activeProgramId = state.programs[0]?.id || null;
      const actProg = state.programById.get(state.activeProgramId);
      if(actProg){
         const sessExists = actProg.sessions.some(s=>s.id===prefs.sessionId);
         state.activeSessionId = sessExists ? prefs.sessionId : actProg.sessions[0]?.id;
      }
      renderAll();
    } catch(e) {
      console.error("Program Load Error", e);
      document.getElementById("content").innerHTML = `<div class="muted">Error loading programs: ${e.message}</div>`;
    }
  }

  // --- INIT & ROBUST SYNC LOAD ---
  async function loadLogsAsync() {
    try {
      // 1. Try LocalStorage (Sync Backup)
      let localLogs = null;
      try { localLogs = JSON.parse(localStorage.getItem(LS_KEY)); } catch {}

      // 2. Try IndexedDB (Async Primary)
      let dbLogs = null;
      if (typeof idbKeyval !== 'undefined') {
        try { dbLogs = await idbKeyval.get(LS_KEY); } catch(e){ console.warn("IDB Fail", e); }
      }

      // 3. Compare Timestamps
      const localTs = localLogs?._updatedAt || 0;
      const dbTs = dbLogs?._updatedAt || 0;

      if (localLogs && localTs > dbTs) {
        console.log("Recovered from LocalStorage backup");
        state.logs = localLogs;
        if(typeof idbKeyval !== 'undefined') idbKeyval.set(LS_KEY, state.logs);
      } else if (dbLogs) {
        state.logs = dbLogs;
      } else {
        state.logs = localLogs || {};
      }

      renderAll();
    } catch(e) {
      console.error("Load Error", e);
      try { state.logs = JSON.parse(localStorage.getItem(LS_KEY)||"{}"); } catch{}
      renderAll();
    }
  }

  // Start
  if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  
  loadAllPrograms();
  loadLogsAsync();
  loadFunFacts(); 
  initAuth();     

  // --- SAFETY NET ---
  // Ensure data persists even if browser freezes mid-save
  window.addEventListener("pagehide", saveLogsInstant);
  window.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") saveLogsInstant();
    if (document.visibilityState === "visible") safeReload(); // Reload on wake
  });

</script>
</body>
</html>