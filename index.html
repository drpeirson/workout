<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#484838" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>BOLT</title>
  <style>
    /* CSS Styles */
    :root{
      --bg:#484838; --panel:#343427; --panel2:#2c2c21; --text:#f7f1df; --muted:#d2c79c;
      --line:#5f5a42; --accent:#f4c300; --good:#35d07f; --warn:#ffc857; --bad:#ff5c7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); background:radial-gradient(1200px 600px at 15% 0%, rgba(244,195,0,.14) 0%, transparent 60%),
      radial-gradient(900px 500px at 100% 25%, rgba(244,195,0,.10) 0%, transparent 55%), var(--bg);
      color:var(--text);
    }
    .app{display:grid; grid-template-columns: 390px 1fr; gap:14px; height:100dvh; min-height:100vh; padding:14px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line);
      border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; min-height:0;}
    header{padding:14px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.01));}
    header .title{font-weight:800; letter-spacing:.2px; font-size:15px;}
    header .subtitle{color:var(--muted); font-size:12px; margin-top:2px;}
    .stack{display:flex; flex-direction:column; gap:10px; padding:12px; flex:1; min-height:0;}
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}
    .btn{appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); padding:9px 10px; border-radius:12px; cursor:pointer; font-weight:650;}
    .btn:hover{border-color:#2d4364}
    .btn.primary{border-color:rgba(110,168,255,.35); background:rgba(110,168,255,.12)}
    .btn.danger{border-color:rgba(255,92,122,.35); background:rgba(255,92,122,.10)}
    .btn.small{padding:7px 9px; font-size:12px; border-radius:10px}
    .pill{font-family:var(--mono); font-size:11px; color:var(--text); background:rgba(244,195,0,.12); border:1px solid rgba(244,195,0,.28); padding:4px 8px; border-radius:999px; display:inline-flex; align-items:center; gap:6px;}
    input[type="text"], input[type="number"], textarea, select{ width:100%; background:rgba(0,0,0,.25); border:1px solid var(--line); color:var(--text); border-radius:12px; padding:9px 10px; outline:none; }
    textarea{min-height:70px; resize:vertical}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .divider{height:1px; background:var(--line); margin:10px 0}
    .sessions{ display:flex; flex-direction:column; gap:8px; overflow:auto; padding-right:6px; padding-bottom:8px; flex:1; min-height:0; }
    .session-item{border:1px solid var(--line); border-radius:14px; padding:10px 10px; cursor:pointer; background:rgba(0,0,0,.18);}
    .session-item:hover{border-color:#2d4364}
    .session-item.active{border-color:rgba(110,168,255,.55); background:rgba(110,168,255,.08)}
    .session-item .name{font-weight:800; font-size:13px}
    .session-item .meta{display:flex; gap:8px; margin-top:6px; flex-wrap:wrap}
    .badge{font-size:11px; color:var(--muted); border:1px solid var(--line); padding:3px 7px; border-radius:999px; background:rgba(255,255,255,.02);}
    .main{display:grid; grid-template-rows:auto 1fr; gap:14px;}
    .content{padding:12px; overflow:auto; height: calc(100vh - 140px);}
    .workout{border:1px solid var(--line); border-radius:16px; background:rgba(0,0,0,.18); margin-bottom:10px; overflow:hidden;}
    .workout-head{padding:12px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; cursor:pointer;}
    .workout-head:hover{background:rgba(255,255,255,.02)}
    .workout-title{font-weight:900}
    .workout-sub{color:var(--muted); font-size:12px; margin-top:3px}
    .workout-body{padding:12px; border-top:1px solid var(--line); display:none}
    .workout.open .workout-body{display:block}
    .grid{display:grid; grid-template-columns: 64px minmax(7ch,1fr) minmax(7ch,1fr) minmax(7ch,1fr) 52px; gap:8px; align-items:center; min-width:0;}
    .grid .h{color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.12em}
    .grid > *{min-width:0;}
    .grid input[type="text"], .grid input[type="number"]{width:100%; min-width:0; max-width:100%; font-family:var(--mono); font-size:16px; padding:9px 10px;}
    .grid input[type="checkbox"]{ transform: scale(1.15); }
    .set-row{padding:8px; border:1px solid rgba(255,255,255,.05); border-radius:14px; background:rgba(255,255,255,.02); margin-top:8px;}
    .done{border-color:rgba(53,208,127,.35); background:rgba(53,208,127,.06);}
    .footer-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .timer-box{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .timer{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--line); border-radius:16px; background:rgba(0,0,0,.18);}
    .timer .time{font-family:var(--mono); font-size:18px; letter-spacing:.06em; min-width:92px; text-align:center;}
    .small-note{font-size:12px; color:var(--muted); line-height:1.35}
    .two-col{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    
    #mobileBrowseRow { display:none; }
    .drawer{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:9999; }
    .drawer.open{ display:block; }
    .drawer .sheet{ position:absolute; left:0; right:0; bottom:0; max-height:85vh; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius: 18px 18px 0 0; box-shadow:var(--shadow); padding:12px; display:flex; flex-direction:column; gap:10px; }
    #authAvatar{width:32px;height:32px;border-radius:999px;border:1px solid var(--line);display:none;object-fit:cover;}
    .authBar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    
    #errorBox { display:none; position:fixed; top:0; left:0; right:0; background:rgba(255,0,0,0.9); color:white; padding:20px; z-index:99999; font-family:monospace; white-space:pre-wrap; }
    
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; height:auto;}
      .content{height:auto; max-height:none;}
      .sessions{max-height:none;}
      .two-col{grid-template-columns:1fr;}
      #mobileBrowseRow{ display:flex; }
      #sessions{ display:none; }
      .grid{display:grid; grid-template-columns: 52px 7ch 7ch 7ch 52px; gap:6px; align-items:center; min-width:0;}
      .grid input[type="text"], .grid input[type="number"]{width:100%; min-width:0; max-width:100%; font-family:var(--mono); font-size:16px; padding:9px 10px;}
      .grid input[type="checkbox"]{ transform: scale(1.15); justify-self:center; }
      #authStatus{display:none;}
      .authBar{gap:8px;}
    }
    
    .stats-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    .stat{ border:1px solid var(--line); border-radius:14px; padding:10px 12px; background:rgba(0,0,0,.18); }
    .statv{ font-family:var(--mono); font-size:20px; font-weight:900; margin-top:6px; letter-spacing:.02em; }
    #planSessionChart{ width:100%; height:260px; display:block; }
    .toplist{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
    .topitem{display:flex;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:8px 10px;background:rgba(255,255,255,.02);}
    .topitem b{font-weight:900;}
    @media (max-width: 980px){ .stats-grid{grid-template-columns: 1fr;} #planSessionChart{height:220px;} }
  </style>
</head>
<body>
  <div id="errorBox"></div>

  <div class="app">
    <div class="card">
      <header>
        <div>
          <div class="title">BOLT</div>
          <div class="subtitle" id="subtitle">Local logs • static plan</div>
        </div>
        <div class="pill" id="sessionCount">0 sessions</div>
      </header>

      <div class="stack">
        <button class="btn danger small" onclick="emergencyReset()" style="align-self:flex-start;">⚠️ Reset App</button>

        <div class="two-col">
          <div>
            <label class="muted" for="programSelect">Program</label>
            <select id="programSelect"></select>
          </div>
          <div>
            <label class="muted" for="sessionSelect">Session</label>
            <select id="sessionSelect"></select>
          </div>
        </div>
        <div class="row">
          <input id="search" type="text" placeholder="Search sessions/workouts…" />
        </div>

        <div class="row">
          <button class="btn primary" id="reloadBtn">Reload plan</button>
          <button class="btn" id="openPlanStats" type="button">Plan stats</button>
          <button class="btn danger" id="clearBtn">Clear logs</button>
        </div>

        <div class="timer-box">
          <div class="timer">
            <div class="time" id="timerDisplay">00:00</div>
            <button class="btn small" id="timerStart">Start</button>
            <button class="btn small" id="timerPause">Pause</button>
            <button class="btn small" id="timerReset">Reset</button>
          </div>
          <select id="preset">
            <option value="60">Rest 60s</option>
            <option value="90">Rest 90s</option>
            <option value="120" selected>Rest 120s</option>
            <option value="180">Rest 180s</option>
          </select>
          <input id="customSeconds" type="number" min="5" step="5" placeholder="Custom seconds" />
          <button class="btn small" id="setCustom">Set</button>
        </div>

        <div class="small-note" id="planHint">
          Put your combined program JSON files in <span class="mono">/data</span>, then edit <span class="mono">PROGRAM_SOURCES</span> in this file.
        </div>

        <div class="row" id="mobileBrowseRow">
          <button class="btn primary" id="openSessions" type="button">Browse sessions</button>
        </div>

        <div class="divider"></div>
        <div class="sessions" id="sessions"></div>

        <div class="footer-actions">
          <button class="btn" id="exportLogs">Export logs (JSON)</button>
          <button class="btn" id="importLogs">Import logs</button>
          <button class="btn" id="exportCSV">Export logs (CSV)</button>
        </div>
        <input id="importFile" type="file" accept=".json,application/json" style="display:none" />
      </div>
    </div>

    <div class="main">
      <div class="card">
        <header>
          <div>
            <div class="title" id="activeTitle">Loading…</div>
            <div class="subtitle" id="activeMeta">—</div>
            <div class="subtitle" id="activeFunFact" style="margin-top:6px;opacity:.9"></div>
          </div>
          <div class="authBar">
            <div class="pill" id="activePill">—</div>
            <img id="authAvatar" alt="profile" />
            <span class="pill" id="authStatus" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Not signed in</span>
            <button class="btn small primary" id="signInGoogle" type="button">Sign in</button>
            <button class="btn small" id="signOut" type="button" style="display:none">Sign out</button>
          </div>
        </header>
        <div class="content" id="content"></div>
      </div>
    </div>
  </div>

  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
        <div style="font-weight:900;">Select a session</div>
        <button class="btn small" id="closeSessions" type="button" style="max-width:120px;">Close</button>
      </div>
      <div class="sessions" id="sessionsDrawer" style="max-height:70vh; overflow:auto;"></div>
    </div>
  </div>

  <div class="drawer" id="planStatsModal" aria-hidden="true">
    <div class="sheet" style="max-height:88vh;">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
        <div style="font-weight:900;">Plan stats</div>
        <button class="btn small" id="closePlanStats" type="button" style="max-width:120px;">Close</button>
      </div>
      <div class="stats-grid">
        <div class="stat"><div class="muted">Total volume</div><div class="statv"><span id="planTotalVolume">0</span> <span class="muted">kg•reps</span></div></div>
        <div class="stat"><div class="muted">Logged sessions</div><div class="statv" id="planLoggedSessions">0</div></div>
        <div class="stat"><div class="muted">Logged sets</div><div class="statv" id="planLoggedSets">0</div></div>
        <div class="stat"><div class="muted">Unique exercises</div><div class="statv" id="planUniqueExercises">0</div></div>
      </div>
      <div class="divider"></div>
      <div class="small-note"><b>Volume by session (top)</b></div>
      <canvas id="planSessionChart" width="900" height="260" style="width:100%;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);"></canvas>
      <div class="divider"></div>
      <div class="small-note"><b>Top exercises</b></div>
      <div class="toplist" id="planTopExercises"></div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/index-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // --- EMERGENCY ERROR HANDLER ---
  window.addEventListener('error', function(e) {
    const box = document.getElementById('errorBox');
    if(box) {
      box.style.display = 'block';
      box.textContent += `Error: ${e.message} at ${e.filename}:${e.lineno}\n\n`;
    }
  });

  function emergencyReset() {
    if(!confirm("Reset app? This clears cached code (fixes bugs). Your logs should be safe.")) return;
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) { registration.unregister(); }
        window.location.reload(true);
      });
    } else {
      window.location.reload(true);
    }
  }

  // --- CONFIG ---
  const PROGRAM_SOURCES = [
    { name: "Hypertrophy", url: "data/hypertrophy.json" },
    { name: "Starting Strongman", url: "data/starting_strongman.json" },
    { name: "Static Monster", url: "data/static_monster.json" },
  ];

  const SUPABASE_URL = "https://redxigdkdjyxaofmutlv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZHhpZ2RrZGp5eGFvZm11dGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMjI5MTQsImV4cCI6MjA4MDc5ODkxNH0.24RNF4dKYNcKkAESiYNbA4_3Fvt-zTCFe5jCjR4vdn0";
  const supabase = (typeof window.supabase !== 'undefined' && SUPABASE_URL.startsWith("http")) 
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) 
    : null;

  const LS_KEY = "mst_tracker_logs_v2";
  const PREFS_KEY = "mst_tracker_prefs_v1";
  let cloudSaveTimer = null;

  // --- STATE ---
  const state = {
    programs: [],
    programById: new Map(),
    sessionsById: new Map(),
    workoutsById: new Map(),
    activeProgramId: null,
    activeSessionId: null,
    logs: {}, 
    timer: { total: 120, left: 120, running: false, t: null }
  };

  // --- HELPERS ---
  function resolveReps(repsStr, setIndex) {
    if (!repsStr) return "";
    const s = String(repsStr);
    if (s.includes(",")) {
      const parts = s.split(",").map(p => p.trim());
      return parts[setIndex] || parts[parts.length - 1];
    }
    return s;
  }

  function uid(str){
    let h = 2166136261;
    for (let i=0; i<str.length; i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return "id_" + (h >>> 0).toString(16);
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  
  function cleanWorkoutTitle(title, programName){
    let t = String(title || "").trim();
    if (!t) return t;
    if (programName){
      const progRe = new RegExp("\\s*-\\s*" + String(programName).replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "\\b.*$", "i");
      if (progRe.test(t)) t = t.replace(progRe, "").trim();
    }
    t = t.replace(/\s*-\s*WEEK\s*\d+\b.*$/i, "").trim();
    t = t.replace(/\s*-\s*Week\s*\d+\b.*$/i, "").trim();
    t = t.replace(/\s*-\s*SESSION\s*\d+\b.*$/i, "").trim();
    return t;
  }

  function toIntMaybe(v){
    if (v == null) return null;
    const s = String(v).trim();
    const n = parseInt(s, 10);
    return Number.isFinite(n) ? n : null;
  }

  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  // --- STORAGE ---
  async function loadLogsAsync() {
    try {
      if (typeof idbKeyval === 'undefined') {
        console.warn("IDB library missing, using localStorage");
        state.logs = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
        renderAll();
        return;
      }
      
      const dbLogs = await idbKeyval.get(LS_KEY);
      if (dbLogs) {
        state.logs = dbLogs;
      } else {
        const local = localStorage.getItem(LS_KEY);
        if (local) {
          state.logs = JSON.parse(local);
          await idbKeyval.set(LS_KEY, state.logs);
        }
      }
      renderAll();
    } catch (e) {
      console.error("Load failed", e);
      state.logs = {}; 
      renderAll();
    }
  }

  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  const saveLogsDebounced = debounce(async () => {
    try {
      if (typeof idbKeyval !== 'undefined') await idbKeyval.set(LS_KEY, state.logs);
      else localStorage.setItem(LS_KEY, JSON.stringify(state.logs));
      
      if(supabase && state._user) {
        const payload = { user_id: state._user.id, logs: state.logs, updated_at: new Date().toISOString() };
        supabase.from("user_logs").upsert(payload, {onConflict:"user_id"}).then(({error}) => {
           if(error) console.error("Cloud save error", error);
        });
      }
    } catch (e) { console.error("Save failed", e); }
  }, 500);

  async function saveLogs() {
    saveLogsDebounced(); // Use debounce even for immediate calls to route logic safely, or call logic directly
    // Force immediate IDB write for safety
    if (typeof idbKeyval !== 'undefined') idbKeyval.set(LS_KEY, state.logs).catch(()=>{});
  }

  // --- LOGIC ---
  function ensureWorkoutLog(session, workout, workoutIndex){
    const k = `${session.programName}|||${session.title}|||${workoutIndex}|||${workout.title}`;
    let wlog = state.logs[k];
    if(!wlog){
      wlog = {
        program: session.programName, session: session.title, workout: workout.title, workoutIndex,
        requiredSets: workout.setCount, requiredReps: workout.targetReps,
        sets: Array.from({length: workout.setCount}, (_,i) => ({
          set: i+1, targetReps: resolveReps(workout.targetReps, i),
          weight:"", reps:"", done:false, note:""
        })),
        workoutNote:""
      };
      state.logs[k] = wlog;
    } else {
      if(!Array.isArray(wlog.sets)) wlog.sets=[];
      while(wlog.sets.length < workout.setCount){
        const i = wlog.sets.length;
        wlog.sets.push({
          set: i+1, targetReps: resolveReps(workout.targetReps, i),
          weight:"", reps:"", done:false, note:""
        });
      }
    }
    return wlog;
  }

  async function loadAllPrograms(){
    try {
      state.programs=[];
      for(const src of PROGRAM_SOURCES){
        const res = await fetch(src.url, {cache:"no-store"});
        if(!res.ok) throw new Error(res.statusText);
        const raw = await res.json();
        
        const prog = { 
          id: uid(`program::${raw.program}`), 
          name: raw.program, 
          sessions: (raw.sessions||[]).map((s,si)=>{
             const sTitle = s.session || `Session ${si+1}`;
             return {
               id: uid(`program::${raw.program}::session::${sTitle}::${si}`),
               title: sTitle,
               programName: raw.program,
               workouts: (s.workouts||[]).map((w,wi)=>{
                 const wTitle = w.title || `Workout ${wi+1}`;
                 const sStr = w.sets??""; const rStr=w.reps??"";
                 
                 // Smart Rep Logic
                 let tReps = String(rStr).trim();
                 if (tReps.toLowerCase() === cleanWorkoutTitle(wTitle, raw.program).toLowerCase()) tReps = "";

                 return {
                   id: uid(`w::${sTitle}::${wi}::${wTitle}`),
                   title: wTitle,
                   setCount: toIntMaybe(sStr) ?? 3,
                   targetReps: tReps,
                   setsStr: String(sStr), repsStr: String(rStr),
                   notes: Array.isArray(w.notes)?w.notes:[]
                 };
               })
             };
          })
        };
        state.programs.push(prog);
      }
      
      // Indexing
      state.programById.clear(); state.sessionsById.clear();
      for(const p of state.programs){
        state.programById.set(p.id, p);
        for(const s of p.sessions) state.sessionsById.set(s.id, s);
      }

      // Prefs
      let prefs = {};
      try{ prefs = JSON.parse(localStorage.getItem(PREFS_KEY)||"{}"); }catch{}
      
      if(prefs.programId && state.programById.has(prefs.programId)) state.activeProgramId = prefs.programId;
      else state.activeProgramId = state.programs[0]?.id || null;

      const actProg = state.programById.get(state.activeProgramId);
      if(actProg){
         const sessExists = actProg.sessions.some(s=>s.id===prefs.sessionId);
         state.activeSessionId = sessExists ? prefs.sessionId : actProg.sessions[0]?.id;
      }

      renderAll();
    } catch(e) {
      console.error("Program Load Error", e);
      document.getElementById("content").innerHTML = `<div class="muted">Error loading programs: ${e.message}</div>`;
    }
  }

  // --- RENDER ---
  function renderAll(){
    const elProg = document.getElementById("programSelect");
    const elSess = document.getElementById("sessionSelect");
    const elList = document.getElementById("sessions");
    const elMain = document.getElementById("content");
    const elHead = document.getElementById("activeTitle");

    // 1. Dropdowns
    elProg.innerHTML = state.programs.map(p=>`<option value="${p.id}" ${p.id===state.activeProgramId?"selected":""}>${escapeHtml(p.name)}</option>`).join("");
    
    const activeProg = state.programById.get(state.activeProgramId);
    const sessions = activeProg?.sessions || [];
    elSess.innerHTML = sessions.map(s=>`<option value="${s.id}" ${s.id===state.activeSessionId?"selected":""}>${escapeHtml(s.title)}</option>`).join("");

    // 2. Sidebar List
    const q = document.getElementById("search").value.toLowerCase();
    const filtered = sessions.filter(s => !q || s.title.toLowerCase().includes(q));
    document.getElementById("sessionCount").textContent = `${sessions.length} sessions`;
    
    elList.innerHTML = filtered.map(s => {
      const active = s.id===state.activeSessionId ? "active" : "";
      return `<div class="session-item ${active}" onclick="pickSession('${s.id}')">
        <div class="name">${escapeHtml(s.title)}</div>
      </div>`;
    }).join("");

    // 3. Main View
    const session = state.sessionsById.get(state.activeSessionId);
    if(!session) {
      elHead.textContent = "No Session";
      elMain.innerHTML = "";
      return;
    }
    
    elHead.textContent = `${session.programName} • ${session.title}`;
    
    // Render Workouts
    elMain.innerHTML = session.workouts.map((w, idx) => {
      const wlog = ensureWorkoutLog(session, w, idx);
      const isLogged = wlog.sets.some(s=>s.done || s.weight || s.reps);
      const badge = isLogged ? '<span class="pill" style="margin-left:8px;border-color:#35d07f;color:#c8ffe2">logged</span>' : '';
      
      const setsHtml = wlog.sets.map(r => {
        const smartTarget = resolveReps(w.targetReps, r.set-1);
        let displayVal = r.targetReps;
        // Fix old bad data or defaults
        if(!displayVal || displayVal===w.targetReps || displayVal.includes(",")) displayVal = smartTarget;

        return `
        <div class="set-row ${r.done?'done':''}">
          <div class="grid">
            <div class="mono">#${r.set}</div>
            <input type="text" placeholder="${smartTarget}" value="${escapeHtml(displayVal)}" oninput="updateSet(this, ${idx}, ${r.set}, 'targetReps')">
            <input type="text" inputmode="decimal" placeholder="kg" value="${escapeHtml(r.weight)}" oninput="updateSet(this, ${idx}, ${r.set}, 'weight')">
            <input type="text" inputmode="numeric" placeholder="reps" value="${escapeHtml(r.reps)}" oninput="updateSet(this, ${idx}, ${r.set}, 'reps')">
            <input type="checkbox" ${r.done?'checked':''} onchange="updateSet(this, ${idx}, ${r.set}, 'done')">
          </div>
          <div style="margin-top:8px">
             <input type="text" placeholder="Notes..." value="${escapeHtml(r.note)}" oninput="updateSet(this, ${idx}, ${r.set}, 'note')">
          </div>
        </div>`;
      }).join("");

      return `
      <div class="workout ${idx===0?'open':''}">
        <div class="workout-head" onclick="toggleWorkout(this)">
          <div>
            <div class="workout-title" id="t_${idx}">${escapeHtml(cleanWorkoutTitle(w.title))} ${badge}</div>
            <div class="workout-sub">Sets ${w.setCount} • Reps ${w.targetReps}</div>
          </div>
          <button class="btn small">Toggle</button>
        </div>
        <div class="workout-body">
          ${w.notes.length ? `<div class="small-note">${w.notes.join("<br>")}</div><div class="divider"></div>` : ""}
          <div class="grid"><div class="h">Set</div><div class="h">Target</div><div class="h">Kg</div><div class="h">Reps</div><div class="h">Done</div></div>
          ${setsHtml}
          <div class="footer-actions">
             <button class="btn small" onclick="modSet(${idx}, 1)">+ Set</button>
             <button class="btn small danger" onclick="modSet(${idx}, -1)">- Set</button>
          </div>
        </div>
      </div>`;
    }).join("");
  }

  // --- ACTIONS (Global Scope for onclick) ---
  window.pickSession = (sid) => {
    state.activeSessionId = sid;
    savePrefs();
    renderAll();
  };

  window.toggleWorkout = (el) => {
    el.closest('.workout').classList.toggle('open');
  };

  window.modSet = (wIdx, delta) => {
    const session = state.sessionsById.get(state.activeSessionId);
    const w = session.workouts[wIdx];
    const wlog = ensureWorkoutLog(session, w, wIdx);
    
    if(delta > 0) {
      wlog.sets.push({
        set: wlog.sets.length+1, 
        targetReps: resolveReps(w.targetReps, wlog.sets.length),
        weight:"", reps:"", done:false, note:""
      });
    } else if (wlog.sets.length > 1) {
      wlog.sets.pop();
    }
    saveLogs();
    renderAll(); // Re-render to show/hide rows
  };

  window.updateSet = (el, wIdx, setNum, field) => {
    const session = state.sessionsById.get(state.activeSessionId);
    const w = session.workouts[wIdx];
    const wlog = ensureWorkoutLog(session, w, wIdx);
    const row = wlog.sets.find(r => r.set === setNum);
    if(!row) return;

    if(field === 'done') {
      row.done = el.checked;
      el.closest('.set-row').classList.toggle('done', row.done);
      saveLogs(); // Instant save for checkboxes
      
      // Live badge update
      const isLogged = wlog.sets.some(s=>s.done||s.weight||s.reps);
      const tEl = document.getElementById(`t_${wIdx}`);
      if(tEl && isLogged && !tEl.innerHTML.includes("logged")) {
         tEl.innerHTML += ' <span class="pill" style="margin-left:8px;border-color:#35d07f;color:#c8ffe2">logged</span>';
      }
    } else {
      row[field] = el.value;
      saveLogsDebounced(); // Lazy save for typing
    }
  };

  // --- INIT ---
  // Listeners
  document.getElementById("programSelect").addEventListener("change", (e)=>{
    state.activeProgramId = e.target.value;
    const p = state.programById.get(state.activeProgramId);
    state.activeSessionId = p?.sessions[0]?.id;
    savePrefs(); renderAll();
  });
  
  document.getElementById("sessionSelect").addEventListener("change", (e)=>{
    state.activeSessionId = e.target.value;
    savePrefs(); renderAll();
  });

  document.getElementById("search").addEventListener("input", renderSessionsList);

  // Start
  if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  loadAllPrograms();
  loadLogsAsync();
</script>
</body>
</html>
