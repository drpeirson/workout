<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#484838" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>BOLT</title>
  <style>
    :root{ --bg:#484838; --panel:#343427; --panel2:#2c2c21; --text:#f7f1df; --muted:#d2c79c; --line:#5f5a42; --accent:#f4c300; --good:#35d07f; --warn:#ffc857; --bad:#ff5c7a; --shadow: 0 10px 30px rgba(0,0,0,.35); --r: 14px; --mono: ui-monospace, SFMono-Regular, Menlo, monospace; --sans: system-ui, -apple-system, sans-serif; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:var(--sans); background:radial-gradient(1200px 600px at 15% 0%, rgba(244,195,0,.14) 0%, transparent 60%), radial-gradient(900px 500px at 100% 25%, rgba(244,195,0,.10) 0%, transparent 55%), var(--bg); color:var(--text); padding-bottom: 50px; }
    .app{display:grid; grid-template-columns: 390px 1fr; gap:14px; height:100dvh; min-height:100vh; padding:14px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; min-height:0;}
    header{padding:14px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.01));}
    header .title{font-weight:800; letter-spacing:.2px; font-size:15px;}
    header .subtitle{color:var(--muted); font-size:12px; margin-top:2px;}
    .stack{display:flex; flex-direction:column; gap:10px; padding:12px; flex:1; min-height:0;}
    .row{display:flex; gap:10px; align-items:center;} .row > *{flex:1}
    .btn{appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); padding:9px 10px; border-radius:12px; cursor:pointer; font-weight:650;}
    .btn:hover{border-color:#2d4364}
    .btn.primary{border-color:rgba(110,168,255,.35); background:rgba(110,168,255,.12)}
    .btn.danger{border-color:rgba(255,92,122,.35); background:rgba(255,92,122,.10)}
    .btn.small{padding:7px 9px; font-size:12px; border-radius:10px}
    .pill{font-family:var(--mono); font-size:11px; color:var(--text); background:rgba(244,195,0,.12); border:1px solid rgba(244,195,0,.28); padding:4px 8px; border-radius:999px; display:inline-flex; align-items:center; gap:6px;}
    input[type="text"], input[type="number"], textarea, select{ width:100%; background:rgba(0,0,0,.25); border:1px solid var(--line); color:var(--text); border-radius:12px; padding:9px 10px; outline:none; }
    textarea{min-height:70px; resize:vertical}
    .muted{color:var(--muted)} .mono{font-family:var(--mono)} .divider{height:1px; background:var(--line); margin:10px 0}
    .sessions{ display:flex; flex-direction:column; gap:8px; overflow:auto; padding-right:6px; padding-bottom:8px; flex:1; min-height:0; }
    .session-item{border:1px solid var(--line); border-radius:14px; padding:10px 10px; cursor:pointer; background:rgba(0,0,0,.18);}
    .session-item:hover{border-color:#2d4364}
    .session-item.active{border-color:rgba(110,168,255,.55); background:rgba(110,168,255,.08)}
    .session-item .name{font-weight:800; font-size:13px}
    .session-item .meta{display:flex; gap:8px; margin-top:6px; flex-wrap:wrap}
    .badge{font-size:11px; color:var(--muted); border:1px solid var(--line); padding:3px 7px; border-radius:999px; background:rgba(255,255,255,.02);}
    .main{display:grid; grid-template-rows:auto 1fr; gap:14px;}
    .content{padding:12px; overflow:auto; height: calc(100vh - 140px);}
    .workout{border:1px solid var(--line); border-radius:16px; background:rgba(0,0,0,.18); margin-bottom:10px; overflow:hidden;}
    .workout-head{padding:12px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; cursor:pointer;}
    .workout-head:hover{background:rgba(255,255,255,.02)}
    .workout-title{font-weight:900}
    .workout-sub{color:var(--muted); font-size:12px; margin-top:3px}
    .workout-body{padding:12px; border-top:1px solid var(--line); display:none}
    .workout.open .workout-body{display:block}
    .grid{display:grid; grid-template-columns: 64px minmax(7ch,1fr) minmax(7ch,1fr) minmax(7ch,1fr) 52px; gap:8px; align-items:center; min-width:0;}
    .grid .h{color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.12em}
    .grid > *{min-width:0;}
    .grid input[type="text"], .grid input[type="number"]{width:100%; min-width:0; max-width:100%; font-family:var(--mono); font-size:16px; padding:9px 10px;}
    .grid input[type="checkbox"]{ transform: scale(1.15); }
    .set-row{padding:8px; border:1px solid rgba(255,255,255,.05); border-radius:14px; background:rgba(255,255,255,.02); margin-top:8px;}
    .done{border-color:rgba(53,208,127,.35); background:rgba(53,208,127,.06);}
    .footer-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .timer-box{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .timer{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--line); border-radius:16px; background:rgba(0,0,0,.18);}
    .timer .time{font-family:var(--mono); font-size:18px; letter-spacing:.06em; min-width:92px; text-align:center;}
    .small-note{font-size:12px; color:var(--muted); line-height:1.35}
    .two-col{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    
    #mobileBrowseRow { display:none; }
    .drawer{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:9999; }
    .drawer.open{ display:block; }
    .drawer .sheet{ position:absolute; left:0; right:0; bottom:0; max-height:85vh; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius: 18px 18px 0 0; box-shadow:var(--shadow); padding:12px; display:flex; flex-direction:column; gap:10px; }
    #authAvatar{width:32px;height:32px;border-radius:999px;border:1px solid var(--line);display:none;object-fit:cover;}
    .authBar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    
    #saveStatus { position:fixed; bottom:20px; right:20px; background:rgba(0,0,0,0.7); color:var(--accent); padding:6px 12px; border-radius:20px; font-size:12px; font-weight:bold; opacity:0; transition:opacity 0.2s; pointer-events:none; z-index:9999; }
    #saveStatus.saving { opacity:1; background:rgba(255,200,0,0.8); color:black; }
    #saveStatus.saved { opacity:0; transition:opacity 1s; background:rgba(53,208,127,0.8); color:black; }
    
    #errorBox { display:none; position:fixed; top:0; left:0; right:0; background:rgba(255,0,0,0.95); color:white; padding:20px; z-index:99999; font-family:monospace; white-space:pre-wrap; pointer-events:all; }
    #debugLog { position:fixed; bottom:0; left:0; right:0; height:40px; background:rgba(0,0,0,0.8); color:#0f0; font-family:monospace; font-size:10px; overflow:hidden; z-index:9998; padding:4px; pointer-events:none; display:block; }
    
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; height:auto;}
      .content{height:auto; max-height:none;}
      .sessions{max-height:none;}
      .two-col{grid-template-columns:1fr;}
      #mobileBrowseRow{ display:flex; }
      #sessions{ display:none; }
      .grid{display:grid; grid-template-columns: 52px 7ch 7ch 7ch 52px; gap:6px; align-items:center; min-width:0;}
      .grid input[type="text"], .grid input[type="number"]{width:100%; min-width:0; max-width:100%; font-family:var(--mono); font-size:16px; padding:9px 10px;}
      .grid input[type="checkbox"]{ transform: scale(1.15); justify-self:center; }
      #authStatus{display:none;}
      .authBar{gap:8px;}
    }
  </style>
</head>
<body>
  <div id="errorBox"></div>
  <div id="saveStatus">Saved</div>
  <div id="debugLog">Initializing...</div>

  <div class="app">
    <div class="card">
      <header>
        <div>
          <div class="title">BOLT</div>
          <div class="subtitle" id="subtitle">Local logs • static plan</div>
        </div>
        <div class="pill" id="sessionCount">0 sessions</div>
      </header>

      <div class="stack">
        <button class="btn danger small" onclick="window.emergencyReset()" style="align-self:flex-start;">⚠️ Reset App</button>
        <div class="two-col">
          <div><label class="muted" for="programSelect">Program</label><select id="programSelect" onchange="window.handleProgramChange(this)"></select></div>
          <div><label class="muted" for="sessionSelect">Session</label><select id="sessionSelect" onchange="window.handleSessionChange(this)"></select></div>
        </div>
        <div class="row"><input id="search" type="text" placeholder="Search sessions/workouts…" oninput="window.renderSessionsList()" /></div>
        <div class="row">
          <button class="btn primary" onclick="window.loadAllPrograms()">Reload plan</button>
          <button class="btn" onclick="window.openPlanStats()">Plan stats</button>
          <button class="btn danger" onclick="window.clearLogs()">Clear logs</button>
        </div>
        <div class="timer-box">
          <div class="timer">
            <div class="time" id="timerDisplay">00:00</div>
            <button class="btn small" onclick="window.startTimer()">Start</button>
            <button class="btn small" onclick="window.pauseTimer()">Pause</button>
            <button class="btn small" onclick="window.resetTimer()">Reset</button>
          </div>
          <select id="preset" onchange="window.setTimer(parseInt(this.value,10))">
            <option value="60">Rest 60s</option><option value="90">Rest 90s</option><option value="120" selected>Rest 120s</option><option value="180">Rest 180s</option>
          </select>
          <input id="customSeconds" type="number" min="5" step="5" placeholder="Custom seconds" />
          <button class="btn small" onclick="window.setCustomTimer()">Set</button>
        </div>
        <div class="small-note" id="planHint">Put your combined program JSON files in <span class="mono">/data</span>.</div>
        <div class="row" id="mobileBrowseRow"><button class="btn primary" onclick="window.openSessionsDrawer()">Browse sessions</button></div>
        <div class="divider"></div>
        <div class="sessions" id="sessions"></div>
        <div class="footer-actions">
          <button class="btn" onclick="window.exportLogs()">Export logs (JSON)</button>
          <button class="btn" onclick="document.getElementById('importFile').click()">Import logs</button>
          <button class="btn" onclick="window.exportCSV()">Export logs (CSV)</button>
        </div>
        <input id="importFile" type="file" accept=".json,application/json" style="display:none" onchange="window.importLogs(this)" />
      </div>
    </div>
    <div class="main">
      <div class="card">
        <header>
          <div>
            <div class="title" id="activeTitle">Loading…</div>
            <div class="subtitle" id="activeMeta">—</div>
            <div class="subtitle" id="activeFunFact" style="margin-top:6px;opacity:.9;font-weight:500;color:var(--accent);"></div>
          </div>
          <div class="authBar">
            <div class="pill" id="activePill">—</div>
            <img id="authAvatar" alt="profile" />
            <span class="pill" id="authStatus" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Not signed in</span>
            <button class="btn small primary" onclick="window.handleSignIn()" id="signInGoogle">Sign in</button>
            <button class="btn small" onclick="window.handleSignOut()" id="signOut" style="display:none">Sign out</button>
          </div>
        </header>
        <div class="content" id="content"></div>
      </div>
    </div>
  </div>

  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
        <div style="font-weight:900;">Select a session</div>
        <button class="btn small" onclick="window.closeSessionsDrawer()">Close</button>
      </div>
      <div class="sessions" id="sessionsDrawer" style="max-height:70vh; overflow:auto;"></div>
    </div>
  </div>

  <div class="drawer" id="planStatsModal" aria-hidden="true">
    <div class="sheet" style="max-height:88vh;">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
        <div style="font-weight:900;">Plan stats</div>
        <button class="btn small" onclick="window.closePlanStats()">Close</button>
      </div>
      <div class="stats-grid">
        <div class="stat"><div class="muted">Total volume</div><div class="statv"><span id="planTotalVolume">0</span> <span class="muted">kg•reps</span></div></div>
        <div class="stat"><div class="muted">Logged sessions</div><div class="statv" id="planLoggedSessions">0</div></div>
        <div class="stat"><div class="muted">Logged sets</div><div class="statv" id="planLoggedSets">0</div></div>
        <div class="stat"><div class="muted">Unique exercises</div><div class="statv" id="planUniqueExercises">0</div></div>
      </div>
      <div class="divider"></div>
      <div class="small-note"><b>Volume by session (top)</b></div>
      <canvas id="planSessionChart" width="900" height="260" style="width:100%;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);"></canvas>
      <div class="divider"></div>
      <div class="small-note"><b>Top exercises</b></div>
      <div class="toplist" id="planTopExercises"></div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/index-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // --- UTILS ---
  function log(msg) {
     const d = document.getElementById("debugLog");
     if(d) d.innerText = msg;
     console.log(msg);
  }
  
  // --- GLOBAL ERROR TRAP ---
  window.onerror = function(msg, url, line, col, error) {
    const box = document.getElementById('errorBox');
    if(box) {
       box.style.display = 'block';
       box.textContent += `Error: ${msg} (Line ${line})\n`;
    }
    log(`CRASH: ${msg}`);
  };

  // --- CONFIG ---
  const PROGRAM_SOURCES = [
    { name: "Hypertrophy", url: "data/hypertrophy.json" },
    { name: "Starting Strongman", url: "data/starting_strongman.json" },
    { name: "Static Monster", url: "data/static_monster.json" },
  ];
  const SUPABASE_URL = "https://redxigdkdjyxaofmutlv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZHhpZ2RrZGp5eGFvZm11dGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMjI5MTQsImV4cCI6MjA4MDc5ODkxNH0.24RNF4dKYNcKkAESiYNbA4_3Fvt-zTCFe5jCjR4vdn0";
  const LS_KEY = "mst_tracker_logs_v2";
  const PREFS_KEY = "mst_tracker_prefs_v1";

  // --- STATE ---
  const state = {
    programs: [], programById: new Map(), sessionsById: new Map(),
    activeProgramId: null, activeSessionId: null,
    logs: {}, 
    timer: { total: 120, left: 120, running: false, t: null },
    funFacts: []
  };
  
  let supabase = null;
  if(typeof window.supabase !== 'undefined') {
     try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } catch(e){ console.error("Supabase Init Fail", e); }
  }

  // --- GLOBAL ACTIONS ---
  window.emergencyReset = () => {
    if(confirm("Reset app? This clears cached code. Your logs are safe.")) {
      if('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r=>r.forEach(i=>i.unregister()));
      window.location.reload(true);
    }
  };
  window.handleSignIn = async () => {
    if(!supabase) return alert("Auth not loaded");
    const {error} = await supabase.auth.signInWithOAuth({provider:"google", options:{redirectTo:location.href}});
    if(error) alert(error.message);
  };
  window.handleSignOut = async () => {
    if(!supabase) return;
    await supabase.auth.signOut();
    location.reload();
  };
  
  // --- CORE LOGIC ---
  window.handleProgramChange = (el) => {
    state.activeProgramId = el.value;
    const p = state.programById.get(state.activeProgramId);
    state.activeSessionId = p?.sessions[0]?.id || null;
    savePrefs(); renderAll();
  };
  window.handleSessionChange = (el) => {
    state.activeSessionId = el.value;
    savePrefs(); renderAll();
  };
  window.pickSession = (sid) => {
    state.activeSessionId = sid;
    savePrefs(); renderAll();
    window.closeSessionsDrawer();
    document.getElementById("content")?.scrollIntoView({behavior:"smooth", block:"start"});
  };
  
  window.renderSessionsList = () => {
    const elList = document.getElementById("sessions");
    const p = state.programById.get(state.activeProgramId);
    const q = document.getElementById("search").value.toLowerCase();
    const sessions = (p?.sessions||[]).filter(s => !q || s.title.toLowerCase().includes(q));
    document.getElementById("sessionCount").textContent = `${sessions.length} sessions`;
    elList.innerHTML = sessions.map(s => {
      const active = s.id === state.activeSessionId ? "active" : "";
      const total = s.workouts.length;
      const done = countLoggedInSession(s);
      return `<div class="session-item ${active}" onclick="window.pickSession('${s.id}')"><div class="name">${escapeHtml(s.title)}</div><div class="meta"><span class="badge">${total} workouts</span><span class="badge">${done}/${total} logged</span></div></div>`;
    }).join("");
  };

  // --- RENDER ---
  function renderAll(){
    log("Rendering UI...");
    try {
        renderProgramSelect();
        renderSessionSelect();
        window.renderSessionsList();
        renderActiveSession();
    } catch(e) {
        log("Render Fail: " + e.message);
        console.error(e);
    }
  }

  function renderProgramSelect(){
    const el = document.getElementById("programSelect");
    el.innerHTML = state.programs.map(p=>`<option value="${p.id}" ${p.id===state.activeProgramId?"selected":""}>${escapeHtml(p.name)}</option>`).join("");
  }
  
  function renderSessionSelect(){
    const p = state.programById.get(state.activeProgramId);
    const el = document.getElementById("sessionSelect");
    // ALWAYS rebuild to prevent uncoupling
    el.innerHTML = (p?.sessions||[]).map(s=>`<option value="${s.id}" ${s.id===state.activeSessionId?"selected":""}>${escapeHtml(s.title)}</option>`).join("");
    el.value = state.activeSessionId;
  }

  function renderActiveSession(){
    const el = document.getElementById("content");
    const session = state.sessionsById.get(state.activeSessionId);
    if(!session) { el.innerHTML="<div class='muted'>No session</div>"; return; }
    
    document.getElementById("activeTitle").textContent = `${session.programName} • ${session.title}`;
    
    // Fun Fact
    try {
        const factEl = document.getElementById("activeFunFact");
        const kg = computeVolume(session);
        if(kg > 0 && state.funFacts.length > 0) {
            const pick = state.funFacts[hashInt(session.id) % state.funFacts.length];
            const count = Math.round(kg / pick.unitKg);
            factEl.textContent = `Lifted ${fmtInt(kg)}kg — equiv to ${fmtInt(count)} ${pick.label}`;
        } else { factEl.textContent = ""; }
    } catch(e){}

    const workouts = getAllWorkoutsForSession(session);
    el.innerHTML = workouts.map((w, idx) => {
       const wlog = ensureWorkoutLog(session, w, idx);
       const logged = wlog.sets.some(s=>s.done||s.weight||s.reps);
       const badge = logged ? `<span class="pill" style="color:#8affc1;border-color:#35d07f33;background:#35d07f1a">logged</span>` : "";
       return `<div class="workout" data-wi="${idx}">
         <div class="workout-head" onclick="window.toggleWorkout(this)">
           <div><div class="workout-title">${escapeHtml(cleanWorkoutTitle(w.title, session.programName))} ${badge}</div>
           <div class="workout-sub">Sets ${w.setsStr} • Reps ${w.repsStr}</div></div>
           <button class="btn small">Toggle</button>
         </div>
         <div class="workout-body">
           ${w.notes?.length ? `<div class="small-note"><b>Plan Notes:</b><br>${w.notes.join("<br>")}</div><div class="divider"></div>`:""}
           <div class="grid"><div class="h">Set</div><div class="h">Target</div><div class="h">Kg</div><div class="h">Reps</div><div class="h">Done</div></div>
           ${wlog.sets.map(r=>renderSetRow(idx, r)).join("")}
           <div class="footer-actions">
             <button class="btn small" onclick="window.modSet(${idx},1)">+ Set</button>
             <button class="btn small danger" onclick="window.modSet(${idx},-1)">- Set</button>
             <button class="btn small" onclick="window.startRest(120)">Start 120s rest</button>
           </div>
           <div class="divider"></div>
           <label class="muted">Notes</label>
           <textarea oninput="window.updateNote(this, ${idx})">${escapeHtml(wlog.workoutNote||"")}</textarea>
         </div>
       </div>`;
    }).join("");
    
    // Add custom box
    el.innerHTML += `<div class="workout"><div class="workout-head" onclick="window.toggleWorkout(this)"><div><div class="workout-title">Add exercise</div></div><button class="btn small">Toggle</button></div><div class="workout-body"><div class="grid" style="grid-template-columns: 1fr 90px 120px;"><div class="h">Exercise</div><div class="h">Sets</div><div class="h">Target reps</div><input id="customTitle" type="text" placeholder="e.g. Arnold press" /><input id="customSets" type="number" min="1" step="1" value="3" /><input id="customReps" type="text" placeholder="e.g. 8-12" /></div><div class="footer-actions"><button class="btn small primary" onclick="window.handleCustomAdd()">Add</button></div></div></div>`;
  }

  function renderSetRow(wIdx, row){
    return `<div class="set-row ${row.done?"done":""}">
      <div class="grid">
        <div class="mono">#${row.set}</div>
        <input type="text" value="${escapeHtml(row.targetReps)}" oninput="window.updateRow(this, ${wIdx}, ${row.set}, 'targetReps')">
        <input type="text" inputmode="decimal" placeholder="kg" value="${escapeHtml(row.weight)}" oninput="window.updateRow(this, ${wIdx}, ${row.set}, 'weight')">
        <input type="text" inputmode="numeric" placeholder="reps" value="${escapeHtml(row.reps)}" oninput="window.updateRow(this, ${wIdx}, ${row.set}, 'reps')">
        <input type="checkbox" ${row.done?"checked":""} onchange="window.updateRow(this, ${wIdx}, ${row.set}, 'done')">
      </div>
    </div>`;
  }

  // --- HELPERS ---
  function uid(str){ let h = 2166136261; for (let i=0; i<str.length; i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); } return "id_" + (h >>> 0).toString(16); }
  function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;"); }
  function cleanWorkoutTitle(t,p){ return t.replace(new RegExp(`\\s*-\\s*${p}.*`,"i"),"").trim(); }
  function resolveReps(s,i){ const p=String(s).split(","); return (p[i]||p[p.length-1]||"").trim(); }
  function fmtTime(s){ return new Date(s*1000).toISOString().substr(14,5); }
  function hashInt(s){ let h=0; for(let i=0;i<s.length;i++) h = Math.imul(31,h)+s.charCodeAt(i)|0; return Math.abs(h); }
  function numFloat(n){ const v=parseFloat(n); return isNaN(v)?null:v; }
  function numInt(n){ const v=parseInt(n); return isNaN(v)?null:v; }
  function fmtInt(n){ return n.toLocaleString(); }
  
  function sessionKey(session){ return `${session.programName}|||${session.title}`; }
  function ensureWorkoutLog(session, w, idx){
     const k = `${session.programName}|||${session.title}|||${idx}|||${w.title}`;
     if(!state.logs[k]) state.logs[k] = { sets: Array.from({length: w.setCount}, (_,i)=>({set:i+1, targetReps:resolveReps(w.targetReps,i), weight:"", reps:"", done:false})) };
     return state.logs[k];
  }
  function getAllWorkoutsForSession(s){
    // Merge plan workouts + custom workouts
    const base = s.workouts || [];
    const customKey = sessionKey(s);
    const custom = (state.logs.__custom_sessions && state.logs.__custom_sessions[customKey]) || [];
    const mappedCustom = custom.map((c, i) => ({
        title: c.title, setCount: c.sets, setsStr: String(c.sets), repsStr: String(c.reps), targetReps: c.reps, notes: [],
        _isCustom: true, _customIndex: i
    }));
    return [...base, ...mappedCustom];
  }
  function countLoggedInSession(s){ return getAllWorkoutsForSession(s).filter((w,i)=>ensureWorkoutLog(s,w,i).sets.some(x=>x.done)).length; }
  function computeVolume(s){
     let t=0; const p=`${s.programName}|||${s.title}|||`;
     for(const k in state.logs){
        if(k.startsWith(p) && state.logs[k].sets) state.logs[k].sets.forEach(r=>{ const w=parseFloat(r.weight), rp=parseInt(r.reps); if(!isNaN(w)&&!isNaN(rp)) t+=w*rp; });
     }
     return t;
  }
  
  // --- STORAGE ---
  function savePrefs(){ try{localStorage.setItem(PREFS_KEY,JSON.stringify({programId:state.activeProgramId, sessionId:state.activeSessionId}));}catch{} }
  function saveLogsInstant(){
    try {
      if(state.logs) state.logs._updatedAt = Date.now();
      localStorage.setItem(LS_KEY, JSON.stringify(state.logs));
      if(typeof idbKeyval !== 'undefined') idbKeyval.set(LS_KEY, state.logs).catch(()=>{});
      
      const el=document.getElementById("saveStatus");
      if(el){ el.style.opacity="1"; setTimeout(()=>el.style.opacity="0",1000); }
      
      // Cloud
      if(supabase && state._user) {
         supabase.from("user_logs").upsert({ user_id: state._user.id, logs: state.logs, updated_at: new Date().toISOString() }, {onConflict:"user_id"}).then(({error})=>{ if(error) console.error(error); });
      }
    } catch(e) { console.error("Save Fail", e); }
  }

  // --- EVENT HANDLERS (HARD WIRED) ---
  window.updateRow = (el, wIdx, setNum, field) => {
    const session = state.sessionsById.get(state.activeSessionId);
    const w = getAllWorkoutsForSession(session)[wIdx];
    const wlog = ensureWorkoutLog(session, w, wIdx);
    const row = wlog.sets.find(r=>r.set===setNum);
    if(row) {
      if(field === 'done') { row.done = el.checked; el.closest('.set-row').classList.toggle('done', row.done); }
      else { row[field] = el.value; }
      saveLogsInstant();
      if(field==='done') renderActiveSession(); // Re-render for badge
    }
  };
  window.updateNote = (el, wIdx) => {
    const session = state.sessionsById.get(state.activeSessionId);
    const w = getAllWorkoutsForSession(session)[wIdx];
    const wlog = ensureWorkoutLog(session, w, wIdx);
    wlog.workoutNote = el.value;
    saveLogsInstant();
  };
  window.toggleWorkout = (el) => { if(event.target.tagName !== "BUTTON") el.closest('.workout').classList.toggle('open'); };
  window.modSet = (wIdx, d) => {
     const session = state.sessionsById.get(state.activeSessionId);
     const w = getAllWorkoutsForSession(session)[wIdx];
     const wlog = ensureWorkoutLog(session, w, wIdx);
     if(d>0) wlog.sets.push({set:wlog.sets.length+1, targetReps:"", weight:"", reps:"", done:false});
     else if(wlog.sets.length>1) wlog.sets.pop();
     saveLogsInstant(); renderActiveSession();
  };
  window.handleCustomAdd = () => {
    const t = document.getElementById("customTitle").value;
    const s = parseInt(document.getElementById("customSets").value)||3;
    const r = document.getElementById("customReps").value;
    if(!t) return alert("Name required");
    
    const session = state.sessionsById.get(state.activeSessionId);
    const key = sessionKey(session);
    if(!state.logs.__custom_sessions) state.logs.__custom_sessions={};
    if(!state.logs.__custom_sessions[key]) state.logs.__custom_sessions[key]=[];
    
    state.logs.__custom_sessions[key].push({ title: t, sets: s, reps: r });
    saveLogsInstant();
    renderActiveSession();
  };
  window.removeCustomWorkout = (idx) => {
    if(!confirm("Remove?")) return;
    const session = state.sessionsById.get(state.activeSessionId);
    const key = sessionKey(session);
    if(state.logs.__custom_sessions && state.logs.__custom_sessions[key]) {
       state.logs.__custom_sessions[key].splice(idx, 1);
       saveLogsInstant();
       renderActiveSession();
    }
  };
  
  // --- TIMER ---
  window.startTimer = () => {
    if(state.timer.left <= 0) state.timer.left = state.timer.total;
    state.timer.endAt = Date.now() + state.timer.left*1000;
    state.timer.running = true;
    if(!state.timer.t) state.timer.t = setInterval(tickTimer, 250);
  };
  window.pauseTimer = () => { state.timer.running = false; renderTimer(); };
  window.resetTimer = () => { state.timer.total = state.timer.total; state.timer.left = state.timer.total; state.timer.running = false; renderTimer(); };
  window.setTimer = (sec) => { state.timer.total = sec; state.timer.left = sec; state.timer.running = false; renderTimer(); };
  window.setCustomTimer = () => { const v = parseInt(document.getElementById("customSeconds").value, 10); if(v) window.setTimer(v); };
  function renderTimer(){ document.getElementById("timerDisplay").textContent = fmtTime(state.timer.left); }
  function tickTimer(){
    if(!state.timer.running) return;
    const now = Date.now();
    const left = Math.max(0, Math.ceil((state.timer.endAt - now)/1000));
    state.timer.left = left;
    renderTimer();
    if(left<=0){ state.timer.running=false; beep(); }
  }

  // --- STATS & EXPORT ---
  window.clearLogs = () => { if(confirm("Clear logs?")) { state.logs={}; saveLogsInstant(); renderAll(); } };
  window.exportLogs = () => {
    const b = new Blob([JSON.stringify(state.logs,null,2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = "bolt_logs.json"; a.click();
  };
  window.openSessionsDrawer = () => {
    document.getElementById("sessionsDrawer").innerHTML = document.getElementById("sessions").innerHTML;
    document.getElementById("drawer").classList.add("open");
  };
  window.closeSessionsDrawer = () => { document.getElementById("drawer").classList.remove("open"); };
  window.openPlanStats = () => { document.getElementById("planStatsModal").classList.add("open"); };
  window.closePlanStats = () => { document.getElementById("planStatsModal").classList.remove("open"); };

  // --- BOOTSTRAP ---
  document.addEventListener("DOMContentLoaded", async () => {
    log("Booting...");
    
    // 1. Load Programs
    try {
      state.programs=[];
      for(const src of PROGRAM_SOURCES) {
         try {
           const res = await fetch(src.url);
           if(res.ok) {
             const data = await res.json();
             const prog = { id: uid(data.program), name: data.program, sessions: data.sessions.map((s,i)=>({...s, id:uid(data.program+s.session+i), programName: data.program})) };
             state.programs.push(prog);
           }
         } catch(e){ console.warn("Skipping " + src.name); }
      }
      // Populate Maps
      state.programById.clear(); state.sessionsById.clear();
      for(const p of state.programs){
        state.programById.set(p.id, p);
        for(const s of p.sessions) state.sessionsById.set(s.id, s);
      }
      log(`Loaded ${state.programs.length} programs`);
      
      // 2. Load Prefs
      try{ 
        const prefs = JSON.parse(localStorage.getItem(PREFS_KEY)||"{}"); 
        if(prefs.programId && state.programById.has(prefs.programId)) state.activeProgramId = prefs.programId;
        else state.activeProgramId = state.programs[0]?.id;
        
        const actProg = state.programById.get(state.activeProgramId);
        if(actProg){
            const sExists = actProg.sessions.some(s=>s.id===prefs.sessionId);
            state.activeSessionId = sExists ? prefs.sessionId : actProg.sessions[0]?.id;
        }
      }catch{}

    } catch(e) { log("Prog Err: " + e.message); }

    // 3. Load Logs
    try {
       const local = JSON.parse(localStorage.getItem(LS_KEY));
       if(local) state.logs = local;
    } catch {}
    
    // 4. Load Fun Facts
    try { state.funFacts = await (await fetch("fun_facts.json")).json(); } catch {}
    
    // 5. Render
    renderAll();

    // 6. Auth
    if(supabase) {
       const {data} = await supabase.auth.getSession();
       if(data.session) {
          state._user = data.session.user;
          document.getElementById("authStatus").textContent = "Signed in";
          document.getElementById("signInGoogle").style.display="none";
          document.getElementById("signOut").style.display="inline-flex";
          // Cloud Load
          const {data:cloud} = await supabase.from("user_logs").select("logs").eq("user_id", state._user.id).maybeSingle();
          if(cloud?.logs && (cloud.logs._updatedAt||0) > (state.logs._updatedAt||0)) {
             state.logs = cloud.logs;
             renderAll();
          }
       }
    }
  });

</script>
</body>
</html>